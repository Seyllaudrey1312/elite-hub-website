<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcements - Elite Hub Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0ea5a4">
</head>
<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-blue-900 text-white flex flex-col">
            <div class="p-6 border-b border-blue-800">
                <h1 class="text-2xl font-bold">Elite Hub Admin</h1>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="admin-dashboard.html" class="block px-4 py-2 rounded-lg hover:bg-blue-800 transition">üìä Dashboard</a>
                <a href="admin-quiz-builder.html" class="block px-4 py-2 rounded-lg hover:bg-blue-800 transition">üìù Create Quiz</a>
                <a href="admin-quiz-results.html" class="block px-4 py-2 rounded-lg hover:bg-blue-800 transition">üìà Quiz Results</a>
				<a href="admin-resources.html" class="block px-4 py-2 rounded-lg hover:bg-blue-800 transition">üìö Resources</a>
				<a href="admin-live-classes.html" class="block px-4 py-2 rounded-lg hover:bg-blue-800 transition">üé• Live Classes</a>
				<a href="admin-video-lessons.html" class="block px-4 py-2 rounded-lg hover:bg-blue-800 transition">üé¨ Video Lessons</a>
                <a href="admin-students.html" class="block px-4 py-2 rounded-lg hover:bg-blue-800 transition">üë• Students</a>
                <a href="admin-announcements.html" class="block px-4 py-2 rounded-lg bg-blue-700">üì¢ Announcements</a>
            </nav>
            <div class="p-4 border-t border-blue-800">
                <button onclick="adminLogout()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                    üö™ Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <div class="p-8">
                <!-- Header -->
                <div class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Announcements</h2>
                        <p class="text-gray-600">Create and manage system announcements for all students</p>
                    </div>
                    <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                        + Create Announcement
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Search</label>
                            <input type="text" id="search-input" placeholder="Search announcements..."
                                onkeyup="filterAnnouncements()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Filter by Status</label>
                            <select id="status-filter" onchange="filterAnnouncements()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Filter by Form</label>
                            <select id="form-filter" onchange="filterAnnouncements()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                                <option value="">All Forms</option>
                                <option value="">General</option>
                                <option value="1">Form 1</option>
                                <option value="2">Form 2</option>
                                <option value="3">Form 3</option>
                                <option value="4">Form 4</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm text-gray-600 mb-2">Total Announcements</p>
                        <p class="text-3xl font-bold text-blue-600" id="total-count">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm text-gray-600 mb-2">Published</p>
                        <p class="text-3xl font-bold text-green-600" id="published-count">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm text-gray-600 mb-2">Drafts</p>
                        <p class="text-3xl font-bold text-yellow-600" id="draft-count">0</p>
                    </div>
                </div>

                <!-- Announcements List -->
                <div id="announcements-container" class="space-y-4">
                    <!-- Announcements will be inserted here -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="bg-white rounded-lg shadow p-12 text-center hidden">
                    <p class="text-gray-600 text-lg mb-4">üì¢ No announcements yet</p>
                    <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                        Create First Announcement
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Create/Edit Modal -->
    <div id="announcement-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 sticky top-0 bg-white">
                <div class="flex justify-between items-center">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">Create Announcement</h3>
                    <button onclick="closeAnnouncementModal()" class="text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
                </div>
            </div>
            <form onsubmit="saveAnnouncement(event)" class="px-6 py-4 space-y-4">
                <input type="hidden" id="announcement-id">
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Title</label>
                    <input type="text" id="title-input" placeholder="Announcement title..."
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" required>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Content</label>
                    <textarea id="content-input" placeholder="Write your announcement..."
                        rows="6"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" required></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Target (All or Specific Form)</label>
                        <select id="target-form"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                            <option value="">All Forms (General)</option>
                            <option value="1">Form 1</option>
                            <option value="2">Form 2</option>
                            <option value="3">Form 3</option>
                            <option value="4">Form 4</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Status</label>
                        <select id="status-input"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                            <option value="draft">Draft</option>
                            <option value="published">Publish Now</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Options</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="send-email-checkbox" class="w-4 h-4">
                            <label for="send-email-checkbox" class="text-gray-700">Also send email to recipients</label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 justify-end pt-4 border-t">
                    <button type="button" onclick="closeAnnouncementModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                        Save Announcement
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script>
        // State
        let allAnnouncements = [];
        let filteredAnnouncements = [];

        // Initialize
        async function init() {
            try {
                // Check admin auth
                checkAdminAuth();

                // Load announcements
                await loadAnnouncements();
            } catch (error) {
                console.error('Error initializing:', error);
                showNotification('Failed to load announcements', 'error');
            }
        }

        async function loadAnnouncements() {
            try {
                const data = await getAllAnnouncements();
                // Expecting an array from backend
                if (Array.isArray(data)) {
                    allAnnouncements = data.map(a => ({
                        _id: a._id,
                        title: a.title,
                        content: a.content,
                        targetForm: (a.targetForms && a.targetForms.length > 0) ? String(a.targetForms[0]) : '',
                        status: a.status || 'published',
                        createdAt: a.createdAt || new Date().toISOString(),
                        createdBy: (a.author && a.author.name) || 'Admin'
                    }));
                } else {
                    // Fallback to demo data
                    allAnnouncements = generateMockAnnouncements();
                }

                filteredAnnouncements = [...allAnnouncements];

                updateStats();
                displayAnnouncements();
            } catch (error) {
                console.error('Error loading announcements:', error);
                showNotification('Failed to load announcements from server ‚Äî using demo data', 'warning');
                allAnnouncements = generateMockAnnouncements();
                filteredAnnouncements = [...allAnnouncements];
                updateStats();
                displayAnnouncements();
            }
        }

        function generateMockAnnouncements() {
            return [
                {
                    _id: '1',
                    title: 'End of Term Exams Starting Soon',
                    content: 'Please note that end of term exams will begin from Monday next week. Make sure to revise all covered topics.',
                    targetForm: '',
                    status: 'published',
                    createdAt: new Date().toISOString(),
                    createdBy: 'Admin'
                },
                {
                    _id: '2',
                    title: 'Mathematics Quiz Tomorrow',
                    content: 'Form 3 Mathematics quiz will be held tomorrow at 2 PM. Please be on time.',
                    targetForm: '3',
                    status: 'published',
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    createdBy: 'Admin'
                },
                {
                    _id: '3',
                    title: 'New Learning Resources Available',
                    content: 'Check the resources section for newly uploaded study materials.',
                    targetForm: '',
                    status: 'draft',
                    createdAt: new Date(Date.now() - 172800000).toISOString(),
                    createdBy: 'Admin'
                }
            ];
        }

        function updateStats() {
            const total = allAnnouncements.length;
            const published = allAnnouncements.filter(a => a.status === 'published').length;
            const drafts = allAnnouncements.filter(a => a.status === 'draft').length;

            document.getElementById('total-count').textContent = total;
            document.getElementById('published-count').textContent = published;
            document.getElementById('draft-count').textContent = drafts;
        }

        function displayAnnouncements() {
            const container = document.getElementById('announcements-container');
            const emptyState = document.getElementById('empty-state');

            if (filteredAnnouncements.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            filteredAnnouncements.forEach(announcement => {
                const date = new Date(announcement.createdAt).toLocaleDateString();
                const statusColor = announcement.status === 'published' ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200';
                const statusBadge = announcement.status === 'published' ? 
                    '<span class="text-green-700 font-bold">‚úÖ Published</span>' : 
                    '<span class="text-yellow-700 font-bold">üìã Draft</span>';

                const formLabel = announcement.targetForm ? `Form ${announcement.targetForm}` : 'All Forms';

                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow p-6 border-l-4 ${statusColor}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">${announcement.title}</h3>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                <span>${date}</span>
                                <span>Target: ${formLabel}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            ${statusBadge}
                        </div>
                    </div>
                    <p class="text-gray-700 mb-4 line-clamp-3">${announcement.content}</p>
                    <div class="flex gap-2 justify-end">
                        <button onclick="editAnnouncement('${announcement._id}')" class="text-blue-600 hover:text-blue-800 font-medium">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="deleteAnnouncement('${announcement._id}')" class="text-red-600 hover:text-red-800 font-medium">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function filterAnnouncements() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const formFilter = document.getElementById('form-filter').value;

            filteredAnnouncements = allAnnouncements.filter(announcement => {
                const matchesSearch = announcement.title.toLowerCase().includes(searchTerm) ||
                    announcement.content.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || announcement.status === statusFilter;
                const matchesForm = !formFilter || announcement.targetForm === formFilter;

                return matchesSearch && matchesStatus && matchesForm;
            });

            displayAnnouncements();
        }

        function openCreateModal() {
            document.getElementById('announcement-id').value = '';
            document.getElementById('modal-title').textContent = 'Create Announcement';
            document.getElementById('title-input').value = '';
            document.getElementById('content-input').value = '';
            document.getElementById('target-form').value = '';
            document.getElementById('status-input').value = 'draft';
            document.getElementById('announcement-modal').classList.remove('hidden');
        }

        function editAnnouncement(id) {
            const announcement = allAnnouncements.find(a => a._id === id);
            if (!announcement) return;

            document.getElementById('announcement-id').value = id;
            document.getElementById('modal-title').textContent = 'Edit Announcement';
            document.getElementById('title-input').value = announcement.title;
            document.getElementById('content-input').value = announcement.content;
            document.getElementById('target-form').value = announcement.targetForm || '';
            document.getElementById('status-input').value = announcement.status;
            document.getElementById('announcement-modal').classList.remove('hidden');
        }

        function closeAnnouncementModal() {
            document.getElementById('announcement-modal').classList.add('hidden');
        }

        async function saveAnnouncement(event) {
            event.preventDefault();

            const id = document.getElementById('announcement-id').value;
            const title = document.getElementById('title-input').value;
            const content = document.getElementById('content-input').value;
            const targetForm = document.getElementById('target-form').value;
            const status = document.getElementById('status-input').value;

            if (id) {
                // Try to update on server (if endpoint exists)
                try {
                    const res = await fetch(`${API_BASE_URL}/announcements/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, content, targetForms: targetForm ? [targetForm] : [] })
                    });

                    if (res.ok) {
                        const updated = await res.json();
                        // Update local list
                        const idx = allAnnouncements.findIndex(a => a._id === id);
                        if (idx !== -1) allAnnouncements[idx] = { ...allAnnouncements[idx], title, content, targetForm, status };
                        showNotification('Announcement updated on server', 'success');
                    } else {
                        // Server doesn't support update - fallback to local
                        const announcement = allAnnouncements.find(a => a._id === id);
                        if (announcement) {
                            announcement.title = title;
                            announcement.content = content;
                            announcement.targetForm = targetForm;
                            announcement.status = status;
                        }
                        showNotification('Server update not available ‚Äî updated locally', 'warning');
                    }
                } catch (err) {
                    console.error('Update failed', err);
                    const announcement = allAnnouncements.find(a => a._id === id);
                    if (announcement) {
                        announcement.title = title;
                        announcement.content = content;
                        announcement.targetForm = targetForm;
                        announcement.status = status;
                    }
                    showNotification('Update failed ‚Äî saved locally', 'warning');
                }
            } else {
                // Create new on server
                try {
                    const payload = { title, content, targetForms: targetForm ? [targetForm] : [] };
                    const res = await fetch(`${API_BASE_URL}/announcements`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const body = await res.json();
                        const created = body.announcement || body;
                        const newAnnouncement = {
                            _id: created._id,
                            title: created.title,
                            content: created.content,
                            targetForm: (created.targetForms && created.targetForms[0]) || targetForm || '',
                            status: created.status || 'published',
                            createdAt: created.createdAt || new Date().toISOString(),
                            createdBy: (created.author && created.author.name) || 'Admin'
                        };
                        allAnnouncements.unshift(newAnnouncement);
                        showNotification('Announcement created successfully', 'success');
                    } else {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.error || 'Create failed');
                    }
                } catch (err) {
                    console.error('Create announcement failed', err);
                    // Fallback to local-only
                    const newAnnouncement = {
                        _id: Date.now().toString(),
                        title,
                        content,
                        targetForm,
                        status,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Admin'
                    };
                    allAnnouncements.unshift(newAnnouncement);
                    showNotification('Failed to create on server ‚Äî saved locally', 'warning');
                }
            }

            // If publish requested and send-email checked, call backend to email students
            const sendEmail = document.getElementById('send-email-checkbox').checked;
            if (status === 'published' && sendEmail) {
                try {
                    await sendEmailNotification(title, content, targetForm);
                    showNotification('Emails queued/sent', 'success');
                } catch (err) {
                    console.error('Send email failed', err);
                    showNotification('Failed to send emails', 'warning');
                }
            }

            filteredAnnouncements = [...allAnnouncements];
            updateStats();
            displayAnnouncements();
            closeAnnouncementModal();
        }

        function deleteAnnouncement(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;

            (async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/announcements/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        allAnnouncements = allAnnouncements.filter(a => a._id !== id);
                        filteredAnnouncements = [...allAnnouncements];
                        updateStats();
                        displayAnnouncements();
                        showNotification('Announcement deleted on server', 'success');
                        return;
                    }
                } catch (err) {
                    console.warn('Server delete failed or not supported', err);
                }

                // Fallback: local delete
                allAnnouncements = allAnnouncements.filter(a => a._id !== id);
                filteredAnnouncements = [...allAnnouncements];
                updateStats();
                displayAnnouncements();
                showNotification('Announcement deleted locally (server delete failed)', 'warning');
            })();
        }

        async function sendEmailNotification(subject, message, targetForm) {
            try {
                const payload = { subject, message, targetForm };
                const res = await fetch(`${API_BASE_URL}/notifications/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                return await res.json();
            } catch (error) {
                console.error('sendEmailNotification error', error);
                throw error;
            }
        }

        function checkAdminAuth() {
            const isAdmin = localStorage.getItem('isAdmin');
            if (!isAdmin) {
                window.location.href = 'admin-login.html';
            }
        }

        function adminLogout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('isAdmin');
            window.location.href = 'admin-login.html';
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
        <script src="../assets/js/pwa-register.js"></script>
</body>
</html>